# Test 06: Webhook Alert System

## 📋 **Tóm tắt Test 06: Webhook Alert System**

### **🎯 Mục đích:**
Test hệ thống webhook alert - kiểm tra xem khi monitor bị lỗi, có gửi webhook notification không.

### **📊 Các bước thực hiện:**

#### **Step 0: Database Cleanup 🧹**
- **Xóa tất cả** monitors, configs và links cũ từ database
- Đảm bảo môi trường test sạch, chỉ có data test của chúng ta

#### **Step 1: Setup Test Servers 🌐**
- **Web Server (Port 6000)**: HTTP server đơn giản trả về HTML status page
- **Webhook Receiver (Port 6001)**: Server nhận webhook calls, log tất cả requests

#### **Step 2: Setup Database with Test Data 📋**
- **Monitor**: 
  - Name: "Test Webhook Monitor"
  - Type: `web_content`
  - URL: `http://localhost:6000` 
  - Interval: 10 giây
  - User ID: 1
- **Config**:
  - Name: "Test Webhook Config"
  - Type: `webhook`
  - URL: `http://localhost:6001/webhook`
  - User ID: 1
- **Link**: Kết nối monitor với config qua bảng `monitor_and_configs`

#### **Step 3: Restart Monitor Service 🔄**
- Stop monitor service cũ
- Start lại để load monitor mới từ database
- Verify service started thành công

#### **Step 4: Wait for Monitor Cycles ⏰**
- Đợi 2 cycles (24 giây) để monitor bắt đầu check
- Kiểm tra webhook calls từ normal operation (expected: 0)

#### **Step 5: Trigger Alert 💥**
- **Stop web server port 6000** → Monitor sẽ không thể connect
- Đây là trigger point để tạo ra alert condition

#### **Step 6: Wait for Alert 📨**
- Đợi 3 cycles (36 giây) để monitor phát hiện lỗi và gửi webhook
- Hệ thống sẽ gửi webhook khi phát hiện consecutive error

#### **Step 7: Verify Results ✅**
- Kiểm tra webhook calls nhận được
- So sánh trước và sau khi trigger alert
- Log chi tiết webhook payload

### **🚀 Kết quả thực tế:**

```json
{
  "timestamp": "2025-09-11T10:59:44.803574",
  "alert_type": "error", 
  "service": {
    "name": "Test Webhook Monitor",
    "url": "http://localhost:6000"
  },
  "message": "Connection error - cannot reach server (Consecutive Error 1)",
  "status": "down",
  "monitor_id": 8,
  "consecutive_errors": 1, 
  "check_interval_seconds": 10,
  "webhook_name": "Test Webhook Config"
}
```

### **📈 Metrics Test:**
- **✅ Successes**: 14 steps
- **❌ Errors**: 0 
- **⏱️ Total Time**: ~100 giây
- **🎯 Result**: **PASSED** - Webhook alert system working perfectly!

### **🔑 Key Points:**
1. **Database Isolation**: Clean environment với chỉ 1 monitor
2. **Real-time Testing**: Actual server start/stop để test thực tế
3. **Webhook Verification**: Capture và verify payload
4. **Service Integration**: Test end-to-end từ monitor → alert → webhook
5. **Timing Control**: Precise timing với monitor intervals

### **🛠️ Technical Implementation:**

#### **Database Schema Used:**
```sql
-- monitor_items: Store monitor configuration
INSERT INTO monitor_items (name, enable, type, url_check, check_interval_seconds, user_id)

-- monitor_configs: Store webhook configuration  
INSERT INTO monitor_configs (name, alert_type, alert_config, user_id, status)

-- monitor_and_configs: Link monitors with alert configs
INSERT INTO monitor_and_configs (monitor_item_id, config_id)
```

#### **Webhook Config Format:**
```
alert_type: 'webhook'
alert_config: 'http://localhost:6001/webhook'  // Simple URL string, not JSON
```

#### **Test Architecture:**
```
Test Server (6000) ←→ Monitor Service ←→ Database
                            ↓ (on error)
                     Webhook Server (6001)
```

### **🔍 Troubleshooting Notes:**

1. **Monitor Service Restart Required**: Sau khi tạo monitor mới, cần restart service để reload database
2. **Webhook URL Format**: Chỉ cần URL string đơn giản, không phải JSON object
3. **Timing Critical**: Monitor interval 10s, cần đợi đủ cycles để trigger alert
4. **Database Cleanup**: Quan trọng để tránh interference từ monitors khác

### **💡 Use Cases:**
Test này chứng minh webhook alert system có thể tích hợp với:
- **Discord Webhooks**
- **Slack Incoming Webhooks** 
- **Microsoft Teams Connectors**
- **Custom API Endpoints**
- **Monitoring Dashboards**

---

**📝 File:** `tests/06.test-webhook-alerts.py`  
**📅 Created:** September 11, 2025  
**✅ Status:** PASSED - Production Ready
