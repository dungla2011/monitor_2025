# Test 06: Webhook Alert System

## ğŸ“‹ **TÃ³m táº¯t Test 06: Webhook Alert System**

### **ğŸ¯ Má»¥c Ä‘Ã­ch:**
Test há»‡ thá»‘ng webhook alert - kiá»ƒm tra xem khi monitor bá»‹ lá»—i, cÃ³ gá»­i webhook notification khÃ´ng.

### **ğŸ“Š CÃ¡c bÆ°á»›c thá»±c hiá»‡n:**

#### **Step 0: Database Cleanup ğŸ§¹**
- **XÃ³a táº¥t cáº£** monitors, configs vÃ  links cÅ© tá»« database
- Äáº£m báº£o mÃ´i trÆ°á»ng test sáº¡ch, chá»‰ cÃ³ data test cá»§a chÃºng ta

#### **Step 1: Setup Test Servers ğŸŒ**
- **Web Server (Port 6000)**: HTTP server Ä‘Æ¡n giáº£n tráº£ vá» HTML status page
- **Webhook Receiver (Port 6001)**: Server nháº­n webhook calls, log táº¥t cáº£ requests

#### **Step 2: Setup Database with Test Data ğŸ“‹**
- **Monitor**: 
  - Name: "Test Webhook Monitor"
  - Type: `web_content`
  - URL: `http://localhost:6000` 
  - Interval: 10 giÃ¢y
  - User ID: 1
- **Config**:
  - Name: "Test Webhook Config"
  - Type: `webhook`
  - URL: `http://localhost:6001/webhook`
  - User ID: 1
- **Link**: Káº¿t ná»‘i monitor vá»›i config qua báº£ng `monitor_and_configs`

#### **Step 3: Restart Monitor Service ğŸ”„**
- Stop monitor service cÅ©
- Start láº¡i Ä‘á»ƒ load monitor má»›i tá»« database
- Verify service started thÃ nh cÃ´ng

#### **Step 4: Wait for Monitor Cycles â°**
- Äá»£i 2 cycles (24 giÃ¢y) Ä‘á»ƒ monitor báº¯t Ä‘áº§u check
- Kiá»ƒm tra webhook calls tá»« normal operation (expected: 0)

#### **Step 5: Trigger Alert ğŸ’¥**
- **Stop web server port 6000** â†’ Monitor sáº½ khÃ´ng thá»ƒ connect
- ÄÃ¢y lÃ  trigger point Ä‘á»ƒ táº¡o ra alert condition

#### **Step 6: Wait for Alert ğŸ“¨**
- Äá»£i 3 cycles (36 giÃ¢y) Ä‘á»ƒ monitor phÃ¡t hiá»‡n lá»—i vÃ  gá»­i webhook
- Há»‡ thá»‘ng sáº½ gá»­i webhook khi phÃ¡t hiá»‡n consecutive error

#### **Step 7: Verify Results âœ…**
- Kiá»ƒm tra webhook calls nháº­n Ä‘Æ°á»£c
- So sÃ¡nh trÆ°á»›c vÃ  sau khi trigger alert
- Log chi tiáº¿t webhook payload

### **ğŸš€ Káº¿t quáº£ thá»±c táº¿:**

```json
{
  "timestamp": "2025-09-11T10:59:44.803574",
  "alert_type": "error", 
  "service": {
    "name": "Test Webhook Monitor",
    "url": "http://localhost:6000"
  },
  "message": "Connection error - cannot reach server (Consecutive Error 1)",
  "status": "down",
  "monitor_id": 8,
  "consecutive_errors": 1, 
  "check_interval_seconds": 10,
  "webhook_name": "Test Webhook Config"
}
```

### **ğŸ“ˆ Metrics Test:**
- **âœ… Successes**: 14 steps
- **âŒ Errors**: 0 
- **â±ï¸ Total Time**: ~100 giÃ¢y
- **ğŸ¯ Result**: **PASSED** - Webhook alert system working perfectly!

### **ğŸ”‘ Key Points:**
1. **Database Isolation**: Clean environment vá»›i chá»‰ 1 monitor
2. **Real-time Testing**: Actual server start/stop Ä‘á»ƒ test thá»±c táº¿
3. **Webhook Verification**: Capture vÃ  verify payload
4. **Service Integration**: Test end-to-end tá»« monitor â†’ alert â†’ webhook
5. **Timing Control**: Precise timing vá»›i monitor intervals

### **ğŸ› ï¸ Technical Implementation:**

#### **Database Schema Used:**
```sql
-- monitor_items: Store monitor configuration
INSERT INTO monitor_items (name, enable, type, url_check, check_interval_seconds, user_id)

-- monitor_configs: Store webhook configuration  
INSERT INTO monitor_configs (name, alert_type, alert_config, user_id, status)

-- monitor_and_configs: Link monitors with alert configs
INSERT INTO monitor_and_configs (monitor_item_id, config_id)
```

#### **Webhook Config Format:**
```
alert_type: 'webhook'
alert_config: 'http://localhost:6001/webhook'  // Simple URL string, not JSON
```

#### **Test Architecture:**
```
Test Server (6000) â†â†’ Monitor Service â†â†’ Database
                            â†“ (on error)
                     Webhook Server (6001)
```

### **ğŸ” Troubleshooting Notes:**

1. **Monitor Service Restart Required**: Sau khi táº¡o monitor má»›i, cáº§n restart service Ä‘á»ƒ reload database
2. **Webhook URL Format**: Chá»‰ cáº§n URL string Ä‘Æ¡n giáº£n, khÃ´ng pháº£i JSON object
3. **Timing Critical**: Monitor interval 10s, cáº§n Ä‘á»£i Ä‘á»§ cycles Ä‘á»ƒ trigger alert
4. **Database Cleanup**: Quan trá»ng Ä‘á»ƒ trÃ¡nh interference tá»« monitors khÃ¡c

### **ğŸ’¡ Use Cases:**
Test nÃ y chá»©ng minh webhook alert system cÃ³ thá»ƒ tÃ­ch há»£p vá»›i:
- **Discord Webhooks**
- **Slack Incoming Webhooks** 
- **Microsoft Teams Connectors**
- **Custom API Endpoints**
- **Monitoring Dashboards**

---

**ğŸ“ File:** `tests/06.test-webhook-alerts.py`  
**ğŸ“… Created:** September 11, 2025  
**âœ… Status:** PASSED - Production Ready
