# Test 07: Telegram Alert System Test
## 📱 Telegram Alerts Testing

### Overview
Test 07 validates the complete Telegram alert system including bot configuration, alert delivery, and recovery notifications. This test ensures the monitoring system can successfully send alerts via Telegram bot API.

### Features Tested
- ✅ Telegram bot configuration loading from `.env.telegram`
- ✅ Database monitor and alert config management
- ✅ Real server simulation for monitoring
- ✅ Alert triggering when server goes down
- ✅ Recovery alert when server comes back online
- ✅ Network-resilient bot connection testing
- ✅ Complete cleanup after testing

### Test Flow

#### 1. Configuration Loading
```
✅ Loads bot token and chat ID from .env.telegram
📋 Validates configuration format: bot_token,chat_id
```

#### 2. Bot Connection Check
```
🔄 Attempts to verify bot via Telegram API
⚠️ Graceful handling of network timeouts
🔄 Continues test even if API unreachable
```

#### 3. Database Setup
```
🧹 Cleans all existing monitors and configs
✅ Creates test monitor (localhost:6000, 10s interval)
✅ Creates telegram alert configuration
🔗 Links monitor with alert config
```

#### 4. Monitor Service Management
```
🛑 Stops existing monitor service
🚀 Starts fresh service to load new config
⏳ Waits for monitor to initialize (24 seconds)
```

#### 5. Alert Testing
```
🌐 Starts test web server on port 6000
🛑 Stops server to trigger alert
📱 Waits for Telegram alert delivery (36 seconds)
```

#### 6. Recovery Testing
```
🌐 Restarts test web server
📱 Waits for recovery alert (36 seconds)
✅ Validates complete alert flow
```

### Configuration Requirements

#### .env.telegram File
```
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_CHAT_ID=your_chat_id
```

#### Database Tables
- `monitor_items`: Stores monitoring endpoints
- `monitor_configs`: Stores alert configurations
- `monitor_and_configs`: Links monitors to configs

### Expected Results
1. **Setup Phase**: Clean database, valid config loading
2. **Monitor Phase**: Service starts and begins monitoring
3. **Alert Phase**: Telegram message sent when server fails
4. **Recovery Phase**: Telegram message sent when server recovers
5. **Cleanup Phase**: All test data removed

### Network Resilience
- ✅ Handles Telegram API timeouts gracefully
- ✅ Continues testing without bot verification if needed
- ✅ Provides clear feedback about network issues

### Success Criteria
- Monitor service starts/stops correctly
- Database operations complete successfully
- Test server lifecycle managed properly
- Alert timing windows respected
- Complete cleanup performed

### Manual Verification
After test completion, check your Telegram chat for:
1. **Alert Message**: Sent when test server stopped
2. **Recovery Message**: Sent when test server restarted

### Environment Variables Used
```
TELEGRAM_THROTTLE_SECONDS=30
CONSECUTIVE_ERROR_THRESHOLD=10  
EXTENDED_ALERT_INTERVAL_MINUTES=5
```

### Test Duration
- **Total Runtime**: ~2.5 minutes
- **Setup**: 30 seconds
- **Alert Wait**: 36 seconds
- **Recovery Wait**: 36 seconds
- **Cleanup**: 15 seconds

### Dependencies
- monitor_service.py running
- PostgreSQL database accessible
- .env.telegram configuration file
- Internet connection (optional for bot verification)

---
**Status**: ✅ Test Passed
**Last Run**: 2025-09-11 11:36:39
**Alerts**: 14 successes, 0 errors
