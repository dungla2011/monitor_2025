# Test 07: Telegram Alert System Test
## ğŸ“± Telegram Alerts Testing

### Overview
Test 07 validates the complete Telegram alert system including bot configuration, alert delivery, and recovery notifications. This test ensures the monitoring system can successfully send alerts via Telegram bot API.

### Features Tested
- âœ… Telegram bot configuration loading from `.env.telegram`
- âœ… Database monitor and alert config management
- âœ… Real server simulation for monitoring
- âœ… Alert triggering when server goes down
- âœ… Recovery alert when server comes back online
- âœ… Network-resilient bot connection testing
- âœ… Complete cleanup after testing

### Test Flow

#### 1. Configuration Loading
```
âœ… Loads bot token and chat ID from .env.telegram
ğŸ“‹ Validates configuration format: bot_token,chat_id
```

#### 2. Bot Connection Check
```
ğŸ”„ Attempts to verify bot via Telegram API
âš ï¸ Graceful handling of network timeouts
ğŸ”„ Continues test even if API unreachable
```

#### 3. Database Setup
```
ğŸ§¹ Cleans all existing monitors and configs
âœ… Creates test monitor (localhost:6000, 10s interval)
âœ… Creates telegram alert configuration
ğŸ”— Links monitor with alert config
```

#### 4. Monitor Service Management
```
ğŸ›‘ Stops existing monitor service
ğŸš€ Starts fresh service to load new config
â³ Waits for monitor to initialize (24 seconds)
```

#### 5. Alert Testing
```
ğŸŒ Starts test web server on port 6000
ğŸ›‘ Stops server to trigger alert
ğŸ“± Waits for Telegram alert delivery (36 seconds)
```

#### 6. Recovery Testing
```
ğŸŒ Restarts test web server
ğŸ“± Waits for recovery alert (36 seconds)
âœ… Validates complete alert flow
```

### Configuration Requirements

#### .env.telegram File
```
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_CHAT_ID=your_chat_id
```

#### Database Tables
- `monitor_items`: Stores monitoring endpoints
- `monitor_configs`: Stores alert configurations
- `monitor_and_configs`: Links monitors to configs

### Expected Results
1. **Setup Phase**: Clean database, valid config loading
2. **Monitor Phase**: Service starts and begins monitoring
3. **Alert Phase**: Telegram message sent when server fails
4. **Recovery Phase**: Telegram message sent when server recovers
5. **Cleanup Phase**: All test data removed

### Network Resilience
- âœ… Handles Telegram API timeouts gracefully
- âœ… Continues testing without bot verification if needed
- âœ… Provides clear feedback about network issues

### Success Criteria
- Monitor service starts/stops correctly
- Database operations complete successfully
- Test server lifecycle managed properly
- Alert timing windows respected
- Complete cleanup performed

### Manual Verification
After test completion, check your Telegram chat for:
1. **Alert Message**: Sent when test server stopped
2. **Recovery Message**: Sent when test server restarted

### Environment Variables Used
```
TELEGRAM_THROTTLE_SECONDS=30
CONSECUTIVE_ERROR_THRESHOLD=10  
EXTENDED_ALERT_INTERVAL_MINUTES=5
```

### Test Duration
- **Total Runtime**: ~2.5 minutes
- **Setup**: 30 seconds
- **Alert Wait**: 36 seconds
- **Recovery Wait**: 36 seconds
- **Cleanup**: 15 seconds

### Dependencies
- monitor_service.py running
- PostgreSQL database accessible
- .env.telegram configuration file
- Internet connection (optional for bot verification)

---
**Status**: âœ… Test Passed
**Last Run**: 2025-09-11 11:36:39
**Alerts**: 14 successes, 0 errors
